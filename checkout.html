<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Checkout - Sucesso</title>
  <link rel="icon" href="images/sucesso fav icon.png" type="image/png">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #ffffff;
      --text: #1a1a1a;
      --gray: #e5e5e5;
      --accent: #233f32;
      --right-bg: #f3f3f3;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Inter', sans-serif;
      background-color: var(--bg);
      color: var(--text);
      overflow-x: hidden;
    }

.loader {
      position: fixed;
      inset: 0;
      background-color: #ffffff;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 999999;
      opacity: 1;
      visibility: visible;
      transition: opacity 0.4s ease, visibility 0.4s ease;
    }

    .loader img {
      width: 120px;
      height: 120px;
      object-fit: contain;
      animation: zoomInClean 2s ease forwards;
    }

    @keyframes zoomInClean {
      0% { transform: scale(0.1); opacity: 0; }
      70% { transform: scale(1.1); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }

    
    header.navbar {
      position: fixed;
      top: 0;
      width: 100%;
      height: 70px;
      background-color: white;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 0 20px;
      z-index: 1001;
      border-bottom: 1px solid #e5e5e5;
    }

    .logo {
      height: 35px;
      margin-top: 20px;
    }

    .checkout-wrapper {
      display: flex;
      max-width: 100%;
      margin-top: 70px;
      height: calc(100vh - 70px);
    }

    .form-section {
      flex: 1;
      padding: 2rem 4rem;
      overflow-y: scroll;
      height: 100%;
    }

    .summary-section {
      width: 50%;
      background: var(--right-bg);
      height: 100%;
      padding: 3rem 2rem;
      position: relative;
    }

    h2 {
      font-size: 1.25rem;
      margin-bottom: 1rem;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    label {
      display: block;
      margin-bottom: 0.3rem;
      font-weight: 500;
    }

    input, select {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--gray);
      border-radius: 4px;
      font-size: 1rem;
    }

    .cart-item {
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
    }

    .cart-item img {
  width: auto;
  height: 150px;
  object-fit: contain;
  border-radius: 2px;
  margin-right: 1rem;
  background-color: #e5e5e5e5;
}


    .cart-info {
      flex: 1;
    }

    .cart-info p {
      margin: 0;
      font-size: 0.9rem;
    }

    .price-section {
      text-align: right;
      margin-top: 1rem;
    }

    .price-section p {
      margin: 0.25rem 0;
      font-size: 0.95rem;
    }

    .total-section {
      margin-top: 1rem;
      font-size: 1.1rem;
      font-weight: 600;
      text-align: right;
    }

    button[type="submit"] {
  display: inline-block;
  background-color: transparent;
  color: #333;
  border: 1px solid #333;
  padding: 0.75rem 1.5rem;
  border-radius: 2px;
  font-weight: 600;
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.3s ease;
  width: 100%;
  margin-top: 2rem;
  text-align: center;
}

button[type="submit"]:hover {
  background-color: #233f32;
  color: #ffffff;
}


    .form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
}

.form-row .form-group {
  margin-bottom: 1rem;
}

.accordion {
  border-radius: 6px;
  border: 1px solid #e5e5e5;
  overflow: hidden;
}

.accordion-item {
  border-bottom: 1px solid #e5e5e5;
}

.accordion-header {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 1rem;
  background: white;
  font-weight: 600;
  cursor: pointer;
}

.accordion-header input[type="radio"] {
  accent-color: var(--accent);
  width: 20px;
  height: 20px;
}

.accordion-panel {
  max-height: 0;
  overflow: hidden;
  opacity: 0;
  transition: all 0.3s ease;
  background: #fafafa;
  padding: 0 1rem;
}

.accordion-panel.open {
  max-height: 400px;
  opacity: 1;
  padding: 1rem;
}

.file-wrapper {
  margin-top: 0.75rem;
}

.file-wrapper label {
  font-weight: 500;
  display: block;
  margin-bottom: 0.3rem;
}

.file-wrapper input[type="file"] {
  border: 1px solid var(--gray);
  padding: 0.5rem;
  border-radius: 4px;
  width: 100%;
  background: white;
}

.file-upload {
  margin-top: 1rem;
}

.file-upload label {
  display: block;
  font-weight: 600;
  margin-bottom: 0.5rem;
  color: #333;
}

.upload-btn {
  display: inline-block;
  background-color: transparent;
      color: #333;
      border: 1px solid #333;
  padding: 0.4rem 1rem; /* m√°s peque√±o */
  border-radius: 2px;
  font-weight: 600;
  font-size: 0.85rem;    /* m√°s chico tambi√©n */
  cursor: pointer;
  transition: background-color 0.3s ease;
  position: relative;
  overflow: hidden;
  text-align: center;
  transition: all 0.3s ease;
}

.upload-btn:hover {
background-color: #233f32;
      color: #ffffff;
}



.file-name {
  margin-top: 0.5rem;
  font-size: 0.9rem;
  color: #666;
  display: block;
}

.label-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 100%;
}

.envio-precio {
  font-weight: 600;
}

.pais-region-wrapper {
  position: relative;
}

/* Label flotante perfectamente dentro del borde */
.pais-region-wrapper label {
  position: absolute;
  top: 7px;
  left: 14px;
  background-color: white;
  padding: 0 4px;
  font-size: 0.75rem;
  color: #888;
  z-index: 2;
  pointer-events: none;
}

/* Select con apariencia nativa y padding ajustado */
.pais-region-wrapper select {
  background-color: white;
  color: #1a1a1a;
  font-weight: 400;
  width: 100%;
  padding: 1.75rem 0.75rem 0.75rem 0.75rem;
  border: 1px solid var(--gray);
  border-radius: 4px;
  font-size: 1rem;
  z-index: 1;
  appearance: auto; /* Esto mantiene la flecha del navegador */
}

/* Opciones internas iguales al select de Estado */
.pais-region-wrapper select option {
  background-color: white;
  color: #1a1a1a;
  font-weight: 400;
}

.custom-upload {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.preview-container {
  position: relative;
  margin-top: 1rem;
  max-width: 300px;
}

.preview-img {
  width: 100%;
  height: auto;
  max-height: 300px;
  object-fit: contain;
  border-radius: 6px;
  display: none;
  background: #f0f0f0;
  padding: 4px;
}

.remove-preview {
  position: absolute;
  top: 4px;
  right: 8px;
  font-size: 18px;
  color: #333;
  cursor: pointer;
  font-weight: bold;
  z-index: 2;
}

@media (max-width: 768px) {
  .checkout-wrapper {
    flex-direction: column;
    height: auto;
  }

  .form-section {
    padding: 1rem;
    height: auto;
  }

  .summary-section {
    width: 100%;
    padding: 1rem;
    height: auto;
    order: -1; /* Para que el resumen aparezca arriba en m√≥vil si lo deseas */
  }

  .cart-item {
    flex-direction: column;
    align-items: flex-start;
  }

  .cart-item img {
    width: 100%;
    height: auto;
    margin: 0 0 0.5rem 0;
  }

  .form-row {
    grid-template-columns: 1fr; /* Todos los inputs en una sola columna */
    gap: 0.5rem;
  }

  button[type="submit"] {
    padding: 1rem;
    font-size: 1.1rem;
  }

  .accordion-header {
    padding: 0.75rem;
  }

  .upload-btn {
    padding: 0.6rem 1rem;
    font-size: 1rem;
  }

  .preview-container {
    max-width: 100%;
  }
}

@media (max-width: 768px) {
  .summary-section {
    padding: 1rem;
  }

  .cart-item {
    flex-direction: row; /* Para que imagen + info est√©n lado a lado */
    align-items: center;
    gap: 0.75rem;
  }

  .cart-item img {
    width: 80px;  /* ajusta seg√∫n lo veas bien */
    height: 80px;
    object-fit: contain;
    margin: 0;
    border-radius: 4px;
    background-color: #e5e5e5;
  }

  .cart-info {
    flex: 1;
  }

  .price-section {
    text-align: right;
    font-size: 0.95rem;
  }

  .total-section {
    font-size: 1rem;
    font-weight: bold;
  }
}

.mobile-order-summary {
  display: none;
  justify-content: space-between;
  align-items: center;
  padding: 1rem;
  border-bottom: 1px solid #e5e5e5;
  background: white;
  font-weight: 600;
  cursor: pointer;
  position: sticky;
  top: 70px;
  z-index: 1000;
}

.mobile-order-summary .summary-header {
  width: 100%;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.mobile-summary-content {
  max-height: 0;
  overflow: hidden;
  background: #f9f9f9;
  padding: 0 1rem;
  opacity: 0;
  transition: max-height 0.4s ease, opacity 0.4s ease, padding 0.4s ease;
}

.mobile-summary-content.open {
  max-height: 1000px; /* valor grande para que se expanda seg√∫n el contenido */
  opacity: 1;
  padding: 1rem;
}


@media (max-width: 768px) {
  .mobile-order-summary {
    display: flex;
  }

  .summary-section {
    display: none;
  }
}

/* Documento con prefijo interno V/E (zona clicable m√≠nima) */
.doc-wrapper {
  position: relative;
}

.doc-wrapper select#doc-prefix {
  position: absolute;
  left: 8px;
  top: 50%;
  transform: translateY(-50%);
  height: 70%;
  /* NUEVO: ancho controlado para que solo cubra la V/E */
  width: 2.8em;           /* suficiente para letra + caret nativo */
  min-width: 36px;        /* evita que se achique demasiado */
  max-width: 48px;        /* evita que se agrande en algunos navegadores */
  padding: 0;             /* sin padding extra */
  text-align: center;     /* centra la V/E */
  border: none;
  border-right: 1px solid var(--gray);
  background: transparent;
  font-size: 0.95rem;
  font-weight: 600;
  color: #233f32;
  outline: none;
  cursor: pointer;
  appearance: auto;       /* mantiene la flecha nativa */
  z-index: 2;             /* por encima del input solo en su ancho */
}

/* Deja espacio solo del ancho real del select */
.doc-wrapper input#documento-number {
  padding-left: 52px;     /* ajusta el espacio para que no se solape */
}

/* Ajuste en mobile para mantener el √°rea reducida */
@media (max-width: 768px) {
  .doc-wrapper select#doc-prefix {
    height: 68%;
    width: 2.8em;
    min-width: 34px;
    max-width: 46px;
  }
  .doc-wrapper input#documento-number {
    padding-left: 50px;
  }
}

  /* ‚úÖ Solo cuando el campo est√© en foco (clic + escribiendo) */
  #discount-code:focus {
border: 2px solid #000 !important; /* grosor 2px y color negro */
  }

/* Estado inicial: deshabilitado */
#apply-discount-btn:disabled {
  background: #f5f5f5 !important;
  color: #999 !important;
  border: 1px solid #d9d9d9 !important;
  cursor: default !important;
  pointer-events: none !important; /* no recibe clics */
}

/* Estado habilitado */
#apply-discount-btn.enabled {
  background: #233f32 !important;
  border: 1px solid #233f32 !important;
  color: #fff !important;
  cursor: pointer !important;
  transition: all 0.3s ease;
  pointer-events: auto !important; /* vuelve a permitir clics */
}

/* Hover cuando est√° habilitado */
#apply-discount-btn.enabled:hover {
  background: #233f32 !important;
  color: #fff !important;
}

:root {
  --error: #b00020;
}

/* Borde rojo para error en el campo de descuento */
.discount-error {
  border: 2px solid var(--error) !important;
}

/* ===== Billing toggle & panel ===== */
.billing-toggle-row {
  display:flex;
  align-items:center;
  gap:.5rem;
  margin:.75rem 0 0.5rem 0;
  font-size:.95rem;
  user-select:none;
}
.billing-toggle-row input[type="checkbox"]{
  width:18px;height:18px; accent-color:#233f32; cursor:pointer;
}

#billing-section {
  border:1px solid #e5e5e5;
  border-radius:6px;
  background:#fafafa;
  overflow:hidden;
  max-height:0;
  opacity:0;
  transform: translateY(-6px);
  transition: max-height .30s ease, opacity .30s ease, transform .30s ease, padding .30s ease;
  padding:0 1rem; /* ser√° 1rem cuando abra */
  margin-top:.25rem;
}

#billing-section.open {
  max-height:650px; /* suficientemente grande para su contenido */
  opacity:1;
  transform: translateY(0);
  padding:1rem;
}

#billing-section .form-row{ display:grid; grid-template-columns:1fr 1fr; gap:1rem; }
@media (max-width:768px){ #billing-section .form-row{ grid-template-columns:1fr; gap:.5rem; } }

/* Pa√≠s/Regi√≥n billing con misma apariencia que shipping */
.billing-pais-wrapper{
  position:relative;
  margin-bottom:1rem;
}
.billing-pais-wrapper label{
  position:absolute; top:7px; left:14px; background:#fff; padding:0 4px;
  font-size:.75rem; color:#888; z-index:2; pointer-events:none;
}
.billing-pais-wrapper select{
  background:#fff; color:#1a1a1a; width:100%;
  padding:1.75rem .75rem .75rem .75rem; border:1px solid #e5e5e5; border-radius:4px; font-size:1rem; appearance:auto;
}


  </style>
</head>
<body>
    <div id="loader" class="loader">
    <img src="images/logo cherry png.png" alt="Sucesso Logo">
  </div>
  
  <header class="navbar">
    <a href="index.html"><img src="images/logo sucesso png.png" alt="Sucesso Logo" class="logo" /></a>
  </header>


<div class="mobile-order-summary" onclick="toggleMobileSummary()">
  <div class="summary-header">
    <span>Resumen del Pedido</span>
    <span id="summary-total">$0.00</span>
    <span id="summary-toggle">+</span>
  </div>
</div>
<div class="mobile-summary-content" id="mobile-summary-content">
  <!-- Esto se llenar√° din√°micamente con el mismo contenido del summary-section -->
</div>

  
  <div class="checkout-wrapper">
    <section class="form-section">
      <form id="checkout-form">
  <h2>Informaci√≥n de Contacto</h2>
  <div class="form-row">
    <div class="form-group">
      <input type="email" id="email" placeholder="Correo Electr√≥nico" required>
    </div>
    <div class="form-group">
      <input type="tel" id="phone" placeholder="Tel√©fono" required>
    </div>
  </div>

  <h2>Entrega</h2>
<div class="form-group pais-region-wrapper">
  <label for="pais">Pa√≠s/Regi√≥n</label>
  <select id="pais" required>
    <option value="Venezuela" selected>Venezuela</option>
  </select>
</div>

  <div class="form-row">
    <div class="form-group">
      <input type="text" id="nombre" placeholder="Nombre" required>
    </div>
    <div class="form-group">
      <input type="text" id="apellido" placeholder="Apellido" required>
    </div>
  </div>




  <div class="form-group">
    <input type="text" id="direccion" placeholder="Direcci√≥n" required>
  </div>

  <div class="form-row">
    <div class="form-group">
      <input type="text" id="ciudad" placeholder="Ciudad" required>
    </div>
    <div class="form-group">
      <input type="text" id="municipio" placeholder="Municipio" required>
    </div>
  </div>

  <div class="form-row">
    <div class="form-group">
  <select id="estado" required>
    <option value="Capital" selected>Capital</option>
    <option value="Amazonas">Amazonas</option>
    <option value="Anzo√°tegui">Anzo√°tegui</option>
    <option value="Apure">Apure</option>
    <option value="Aragua">Aragua</option>
    <option value="Barinas">Barinas</option>
    <option value="Bol√≠var">Bol√≠var</option>
    <option value="Carabobo">Carabobo</option>
    <option value="Cojedes">Cojedes</option>
    <option value="Delta Amacuro">Delta Amacuro</option>
    <option value="Falc√≥n">Falc√≥n</option>
    <option value="Gu√°rico">Gu√°rico</option>
    <option value="Lara">Lara</option>
    <option value="M√©rida">M√©rida</option>
    <option value="Miranda">Miranda</option>
    <option value="Monagas">Monagas</option>
    <option value="Nueva Esparta">Nueva Esparta</option>
    <option value="Portuguesa">Portuguesa</option>
    <option value="Sucre">Sucre</option>
    <option value="T√°chira">T√°chira</option>
    <option value="Trujillo">Trujillo</option>
    <option value="Vargas">Vargas</option>
    <option value="Yaracuy">Yaracuy</option>
    <option value="Zulia">Zulia</option>
  </select>
</div>

    <div class="form-group">
  <input type="text" id="postal" placeholder="C√≥digo Postal" required>
</div>

  </div>

<!-- ======= Facturaci√≥n: toggle + panel ======= -->
<div class="billing-toggle-row">
  <input type="checkbox" id="use-shipping-as-billing" checked>
  <label for="use-shipping-as-billing">Usar direcci√≥n de env√≠o como direcci√≥n de facturaci√≥n</label>
</div>

<div id="billing-section" aria-hidden="true">
  <h2 style="margin:0 0 .5rem 0;">Facturaci√≥n</h2>

  <div class="billing-pais-wrapper">
    <label for="billing-pais">Pa√≠s/Regi√≥n</label>
    <select id="billing-pais">
      <option value="Venezuela" selected>Venezuela</option>
    </select>
  </div>

  <div class="form-row">
    <div class="form-group">
      <input type="text" id="billing-nombre" placeholder="Nombre">
    </div>
    <div class="form-group">
      <input type="text" id="billing-apellido" placeholder="Apellido">
    </div>
  </div>

<div class="form-group doc-wrapper">
  <select id="doc-prefix" aria-label="Tipo de documento">
    <option value="V" selected>V</option>
    <option value="E">E</option>
  </select>
  <input
    type="text"
    id="documento-number"
    placeholder="C√©dula de Identidad"
    inputmode="numeric"
    autocomplete="off"
    maxlength="10"
  >
</div>

  <div class="form-group">
    <input type="text" id="billing-direccion" placeholder="Direcci√≥n">
  </div>

  <div class="form-row">
    <div class="form-group">
      <input type="text" id="billing-ciudad" placeholder="Ciudad">
    </div>
    <div class="form-group">
      <input type="text" id="billing-municipio" placeholder="Municipio">
    </div>
  </div>

  <div class="form-row">
    <div class="form-group">
      <select id="billing-estado">
        <option value="Capital" selected>Capital</option>
        <option value="Amazonas">Amazonas</option>
        <option value="Anzo√°tegui">Anzo√°tegui</option>
        <option value="Apure">Apure</option>
        <option value="Aragua">Aragua</option>
        <option value="Barinas">Barinas</option>
        <option value="Bol√≠var">Bol√≠var</option>
        <option value="Carabobo">Carabobo</option>
        <option value="Cojedes">Cojedes</option>
        <option value="Delta Amacuro">Delta Amacuro</option>
        <option value="Falc√≥n">Falc√≥n</option>
        <option value="Gu√°rico">Gu√°rico</option>
        <option value="Lara">Lara</option>
        <option value="M√©rida">M√©rida</option>
        <option value="Miranda">Miranda</option>
        <option value="Monagas">Monagas</option>
        <option value="Nueva Esparta">Nueva Esparta</option>
        <option value="Portuguesa">Portuguesa</option>
        <option value="Sucre">Sucre</option>
        <option value="T√°chira">T√°chira</option>
        <option value="Trujillo">Trujillo</option>
        <option value="Vargas">Vargas</option>
        <option value="Yaracuy">Yaracuy</option>
        <option value="Zulia">Zulia</option>
      </select>
    </div>

    <div class="form-group">
      <input type="text" id="billing-postal" placeholder="C√≥digo Postal" required>
    </div>
  </div>
</div>


<h2>M√©todos de Env√≠o</h2>
<div class="accordion" id="envio-accordion">
  <div class="accordion-item">
    <label class="accordion-header">
  <input type="radio" name="metodo-envio" value="capital" data-costo="3.00" checked>
  <div class="label-content">
    <span>CAPITAL</span>
    <span class="envio-precio">$3.00</span>
  </div>
</label>
    <div class="accordion-panel">
      <p>Env√≠o r√°pido dentro de la Capital. Tiempo estimado: 1-2 d√≠as h√°biles.</p>
    </div>
  </div>

  <div class="accordion-item">
    <label class="accordion-header">
  <input type="radio" name="metodo-envio" value="resto" data-costo="0.00">
  <div class="label-content">
    <span>RESTO DE VENEZUELA</span>
    <span class="envio-precio">GRATIS</span>
  </div>
</label>
    <div class="accordion-panel">
      <p>El cliente ser√° quien asume el costo de env√≠o una vez retire su pedido en el MRW especificado</p>
    </div>
  </div>
</div>


<h2>M√©todos de Pago</h2>

<div class="accordion">
  <div class="accordion-item">
    <label class="accordion-header">
      <input type="radio" name="metodo-pago" value="pago-movil" checked>
      <span>Pago M√≥vil</span>
    </label>
    <div class="accordion-panel">
  <p>Banco: Banco Nacional de Cr√©dito<br>N√∫mero: 0424-1333923<br>C√©dula: V-32904616<br>Nombre: Lian Beraja</p>
  <div class="file-upload">
  <label for="ref-pago-movil">Adjuntar referencia</label>
  <div class="custom-upload">
    <button type="button" class="upload-btn" onclick="document.getElementById('ref-pago-movil').click()">Seleccionar archivo</button>
<input type="file" id="ref-pago-movil" name="comprobante-pago-movil" accept="image/*" style="display: none;">
  </div>
  <div class="preview-container" id="container-pago-movil" style="display: none;">
    <span class="remove-preview" onclick="eliminarPreview('ref-pago-movil', 'preview-pago-movil', 'container-pago-movil')">x</span>
    <img class="preview-img" id="preview-pago-movil" alt="Preview" />
  </div>
</div>
  </div>
</div>



  <div class="accordion-item">
    <label class="accordion-header">
      <input type="radio" name="metodo-pago" value="transferencia">
      <span>Transferencia Bancaria Nacional</span>
    </label>
    <div class="accordion-panel">
  <p>
    Banco: Mercantil<br>
    Cuenta: 0105-1234-5678-9012-3456<br>
    Nombre: SUCESSO C.A.<br>
    RIF: J-12345678-9
  </p>
  <div class="file-upload">
  <label for="ref-transferencia">Adjuntar referencia</label>
  <div class="custom-upload">
    <button type="button" class="upload-btn" onclick="document.getElementById('ref-transferencia').click()">Seleccionar archivo</button>
    <input type="file" id="ref-transferencia" name="comprobante-transferencia" accept="image/*" style="display: none;">
  </div>
  <div class="preview-container" id="container-transferencia" style="display: none;">
    <span class="remove-preview" onclick="eliminarPreview('ref-transferencia', 'preview-transferencia', 'container-transferencia')">x</span>
    <img class="preview-img" id="preview-transferencia" alt="Preview" />
  </div>
</div>
  </div>
</div>


  <div class="accordion-item">
  <label class="accordion-header">
    <input type="radio" name="metodo-pago" value="paypal">
    <span>PayPal</span>
  </label>
  <div class="accordion-panel">
    <p>Email: pagos@sucesso.com<br>Moneda: USD</p>
    <div class="file-upload">
      <label for="ref-paypal">Adjuntar referencia</label>
      <div class="custom-upload">
        <button type="button" class="upload-btn" onclick="document.getElementById('ref-paypal').click()">Seleccionar archivo</button>
        <input type="file" id="ref-paypal" name="comprobante-paypal" accept="image/*" style="display: none;">
      </div>
      <div class="preview-container" id="container-paypal" style="display: none;">
        <span class="remove-preview" onclick="eliminarPreview('ref-paypal', 'preview-paypal', 'container-paypal')">x</span>
        <img class="preview-img" id="preview-paypal" alt="Preview" />
      </div>
    </div>
  </div>
</div>

<div class="accordion-item">
  <label class="accordion-header">
    <input type="radio" name="metodo-pago" value="zelle">
    <span>Zelle</span>
  </label>
  <div class="accordion-panel">
    <p>Email: zelle@sucesso.com<br>Nombre: SUCESSO C.A.</p>
    <div class="file-upload">
      <label for="ref-zelle">Adjuntar referencia</label>
      <div class="custom-upload">
        <button type="button" class="upload-btn" onclick="document.getElementById('ref-zelle').click()">Seleccionar archivo</button>
        <input type="file" id="ref-zelle" name="comprobante-zelle" accept="image/*" style="display: none;">
      </div>
      <div class="preview-container" id="container-zelle" style="display: none;">
        <span class="remove-preview" onclick="eliminarPreview('ref-zelle', 'preview-zelle', 'container-zelle')">x</span>
        <img class="preview-img" id="preview-zelle" alt="Preview" />
      </div>
    </div>
  </div>
</div>

  <div class="accordion-item">
    <label class="accordion-header">
      <input type="radio" name="metodo-pago" value="efectivo">
      <span>Pago en Efectivo</span>
    </label>
    <div class="accordion-panel">
      <p>El pago se realizar√° contra entrega.</p>
    </div>
  </div>
</div>


  <button type="submit">Confirmar Compra</button>
</form>

    </section>

    <section class="summary-section">
      <h2>Resumen del Pedido</h2>
      <div id="cart-items"></div>
      
<!-- DESCUENTO / GIFT CARD -->
<div class="discount-box" style="margin:16px 0;">
  <div style="display:flex; gap:8px; align-items:center;">
    <input id="discount-code" type="text" 
           placeholder="C√≥digo de descuento o tarjeta de regalo"
           style="flex:1; height:48px; padding:0 12px; border:1px solid #d9d9d9; border-radius:6px; font-size:14px; color:#333; outline:none;">
    <button id="apply-discount-btn" type="button"
            style="padding:0 16px; height:48px; border:1px solid #d9d9d9; background:#f5f5f5; color:#333; border-radius:6px; font-size:14px; font-weight:500; cursor:pointer;">
      Aplicar
    </button>
  </div>
  <div id="discount-msg" style="margin-top:8px; font-size:0.9rem; color:#233f32;"></div>
</div>

      <div class="price-section">
        <p><strong>Subtotal:</strong> <span id="subtotal-value">$0.00</span></p>
          <p><strong>Descuento:</strong> <span id="discount-value">-$0.00</span></p>
        <p><strong>Env√≠o:</strong> <span id="envio-cost">$0.00</span></p>
      </div>
      <div class="total-section">
        Total: <span id="total-final">$0.00</span>
      </div>
    </section>
  </div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const discountInput = document.getElementById("discount-code");
    const applyBtn = document.getElementById("apply-discount-btn");

    // Deshabilitar inicialmente
    applyBtn.disabled = true;

    discountInput.addEventListener("input", () => {
      if (discountInput.value.trim().length > 0) {
        applyBtn.disabled = false;
        applyBtn.classList.add("enabled");
      } else {
        applyBtn.disabled = true;
        applyBtn.classList.remove("enabled");
      }
    });
  });
</script>

<script>
window.addEventListener("load", () => {
  const loader = document.getElementById("loader");
  setTimeout(() => {
    loader.style.opacity = "0";
    loader.style.visibility = "hidden";
    setTimeout(() => {
      loader.style.display = "none";
    }, 400); // Tiempo igual al transition del CSS
  }, 2500);
});
</script>
  
  <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- Documento: permitir solo d√≠gitos en el n√∫mero ---
  const docNumberInput = document.getElementById("documento-number");
  docNumberInput.addEventListener("input", () => {
    // elimina todo lo que no sea d√≠gito
    docNumberInput.value = docNumberInput.value.replace(/\D+/g, "");
  });

      const cartContainer = document.getElementById('cart-items');
      const subtotalValue = document.getElementById('subtotal-value');
      const totalFinal = document.getElementById('total-final');

      const carrito = JSON.parse(localStorage.getItem('carrito')) || [];
      let subtotal = 0;

      if (carrito.length === 0) {
        cartContainer.innerHTML = '<p>No hay productos en el carrito.</p>';
        return;
      }

      cartContainer.innerHTML = '';

      carrito.forEach(producto => {
        const nombre = producto.nombre || producto.name || 'Producto';
        const cantidad = producto.cantidad || producto.quantity || 1;
        const precioRaw = producto.precio || producto.price || "$0";
        const precio = typeof precioRaw === 'string' ? parseFloat(precioRaw.replace(/[^0-9.-]+/g, '')) : precioRaw;
        const imagen = producto.image || producto.imagen_frontal || 'images/default.jpg';

        const item = document.createElement('div');
        item.className = 'cart-item';
        item.innerHTML = `
          <img src="${imagen}" alt="${nombre}">
          <div class="cart-info">
            <p><strong>${nombre}</strong></p>
              <p>Talla: ${producto.size || '√önica'}</p>
            <p>Cantidad: ${cantidad}</p>
          </div>
          <div>
            $${(precio * cantidad).toFixed(2)}
          </div>
        `;

        cartContainer.appendChild(item);
        subtotal += precio * cantidad;
      });

      subtotalValue.textContent = `$${subtotal.toFixed(2)}`;
      totalFinal.textContent = `$${subtotal.toFixed(2)}`;
    });
  </script>

<script>
/* ============ CUPONES CONFIGURABLES ============

Edita/a√±ade tus c√≥digos aqu√≠. Dos tipos:
- type: "percent" (valor en %)  | p.ej. 10 = 10%
- type: "fixed"   (valor en USD) | p.ej. 5  = $5.00

Opcionales:
- minSubtotal: m√≠nimo de compra para aplicar
- expires: "YYYY-MM-DD" (UTC)   -> fecha l√≠mite inclusive
*/
const COUPONS = {
  "SUCESSO10": { type: "percent", value: 10,  minSubtotal: 0,  expires: "2030-12-31" },
  "LIAN":      { type: "fixed",   value: 50,   minSubtotal: 15, expires: "2030-12-31" },
  "SUCE550":   { type: "fixed",   value: 200,  minSubtotal: 0,  expires: "2030-12-31" },
  // agrega los tuyos aqu√≠...
};

(function initDiscountSystem(){
  // Estado centralizado
  const desktopSummary  = document.querySelector(".summary-section");
  const mobileSummary   = document.getElementById("mobile-summary-content");

  // Intenta leer el subtotal ya renderizado por tu c√≥digo
  const parseMoney = s => (parseFloat(String(s).replace(/[^0-9.-]+/g,'')) || 0);
  const fmt = n => `$${(n).toFixed(2)}`;

  // Guardamos valores maestros en window para reuso sin tocar tus scripts
  window.__checkoutState = window.__checkoutState || {
    subtotal: parseMoney(document.getElementById("subtotal-value")?.textContent || 0),
    shipping: parseMoney(document.querySelector('input[name="metodo-envio"]:checked')?.getAttribute("data-costo") || 0),
    discount: 0,
    code: null
  };

  // Helpers para seleccionar en desktop/m√≥vil sin chocar IDs clonados
  const $d = sel => desktopSummary?.querySelector(sel);
  const $m = sel => mobileSummary?.querySelector(sel);

  function renderTotals(){
    const st  = window.__checkoutState;
    // corrige si por alguna raz√≥n cambi√≥ el subtotal ya pintado por tus scripts
    st.subtotal = parseMoney($d("#subtotal-value")?.textContent || st.subtotal);

    const maxDiscount = Math.min(st.discount, st.subtotal); // jam√°s m√°s que el subtotal
    const total = st.subtotal - maxDiscount + st.shipping;

    // Desktop
    if ($d("#discount-value")) $d("#discount-value").textContent = `-$${maxDiscount.toFixed(2)}`;
    if ($d("#envio-cost"))     $d("#envio-cost").textContent     = fmt(st.shipping);
    if ($d("#total-final"))    $d("#total-final").textContent    = fmt(total);

    // Mobile (los mismos IDs existen dentro del contenedor clonado)
    if ($m("#discount-value")) $m("#discount-value").textContent = `-$${maxDiscount.toFixed(2)}`;
    if ($m("#envio-cost"))     $m("#envio-cost").textContent     = fmt(st.shipping);
    if ($m("#total-final"))    $m("#total-final").textContent    = fmt(total);

    const headerTotal = document.getElementById("summary-total");
    if (headerTotal) headerTotal.textContent = fmt(total);
  }

  function readShipping(){
    const checked = document.querySelector('input[name="metodo-envio"]:checked');
    window.__checkoutState.shipping = parseMoney(checked?.getAttribute("data-costo") || 0);
  }

  function validateAndComputeDiscount(code){
    if (!code) return {ok:false, msg:"Ingresa un c√≥digo."};
    const c = COUPONS[code.trim().toUpperCase()];
    if (!c) return {ok:false, msg:"C√≥digo inv√°lido o vencido."};

    // vencimiento
    if (c.expires) {
      const today = new Date(); today.setHours(0,0,0,0);
      const exp = new Date(c.expires+"T00:00:00Z");
      if (today.getTime() > exp.getTime()) return {ok:false, msg:"El c√≥digo est√° vencido."};
    }

    // m√≠nimo
    const st = window.__checkoutState;
    if (c.minSubtotal && st.subtotal < c.minSubtotal) {
      return {ok:false, msg:`M√≠nimo de compra: $${c.minSubtotal.toFixed(2)}.`};
    }

    // valor
    let discount = 0;
    if (c.type === "percent") discount = st.subtotal * (c.value/100);
    else if (c.type === "fixed") discount = c.value;
    discount = Math.max(0, Math.min(discount, st.subtotal)); // cap

    return {ok:true, discount, meta:c};
  }

  function attachBox(scope){
    if (!scope) return;
    const codeInput = scope.querySelector("#discount-code");
    const btn       = scope.querySelector("#apply-discount-btn");
    const msgEl     = scope.querySelector("#discount-msg");
    if (!codeInput || !btn) return;

    // üî¥/‚úÖ Helper para controlar el borde rojo de error
    const setErrorBorder = (on) => {
      if (on) codeInput.classList.add("discount-error");
      else codeInput.classList.remove("discount-error");
    };

    // ‚õîÔ∏è Evitar re-habilitar si ya se aplic√≥ (aunque otros scripts intenten)
    codeInput.addEventListener("input", () => {
      if (btn.dataset.locked === "1") {
        // mantener limpio y bloqueado
        codeInput.value = "";
        btn.disabled = true;
        btn.classList.remove("enabled");
      }
    });

    const apply = () => {
      const code = codeInput.value.trim();
      const res = validateAndComputeDiscount(code);

      msgEl && (msgEl.style.color = res.ok ? "#0b7a5c" : "#b00020");

      if (!res.ok){
        setErrorBorder(true);
        window.__checkoutState.discount = 0;
        window.__checkoutState.code = null;
        if (msgEl) msgEl.textContent = res.msg;
        renderTotals();
        return;
      }

      // ‚úÖ C√≥digo correcto: aplicar descuento
      setErrorBorder(false);
      window.__checkoutState.discount = res.discount;
      window.__checkoutState.code = code.toUpperCase();
      if (msgEl) msgEl.textContent = `C√≥digo aplicado: ${window.__checkoutState.code} (-${fmt(res.discount)})`;
      renderTotals();

      // üîí NUEVO: limpiar input y bloquear bot√≥n definitivamente en esta sesi√≥n
      codeInput.value = "";
      btn.disabled = true;
      btn.classList.remove("enabled");
      btn.dataset.locked = "1";
    };

    btn.addEventListener("click", apply);
    codeInput.addEventListener("keydown", (e)=>{ if (e.key === "Enter") { e.preventDefault(); apply(); }});
  }

  // Env√≠o cambia: recalculamos despu√©s de tus listeners
  document.querySelectorAll('input[name="metodo-envio"]').forEach(r=>{
    r.addEventListener("change", ()=>{ readShipping(); renderTotals(); });
  });

  // Estado inicial
  readShipping();
  renderTotals();

  // Conectar cajas (desktop y m√≥vil)
  attachBox(desktopSummary);
  attachBox(mobileSummary);

  // Exponer para que otros scripts puedan forzar un repaint si cambian algo
  window.__renderTotalsWithDiscount = renderTotals;

  // Permite re-vincular la caja de descuento en el contenedor m√≥vil tras el clonado
  window.__rebindDiscountBox = () => {
    const mobile = document.getElementById("mobile-summary-content");
    if (mobile) {
      if (mobile.querySelector("#discount-code") && mobile.querySelector("#apply-discount-btn")) {
        (function(scope){
          const codeInput = scope.querySelector("#discount-code");
          const btn = scope.querySelector("#apply-discount-btn");
          const msgEl = scope.querySelector("#discount-msg");
          if (!codeInput || !btn) return;

          const setErrorBorder = (on) => {
            if (on) codeInput.classList.add("discount-error");
            else codeInput.classList.remove("discount-error");
          };

          // ‚õîÔ∏è Mantener bloqueo en m√≥vil tambi√©n
          codeInput.addEventListener("input", () => {
            if (btn.dataset.locked === "1") {
              codeInput.value = "";
              btn.disabled = true;
              btn.classList.remove("enabled");
            }
          });

          const apply = () => {
            const code = codeInput.value.trim();
            const res = (typeof validateAndComputeDiscount === "function")
              ? validateAndComputeDiscount(code)
              : (window.validateAndComputeDiscount && window.validateAndComputeDiscount(code));
            if (!res) return;

            msgEl && (msgEl.style.color = res.ok ? "#0b7a5c" : "#b00020");

            if (!res.ok){
              setErrorBorder(true);
              window.__checkoutState.discount = 0;
              window.__checkoutState.code = null;
              if (msgEl) msgEl.textContent = res.msg;
              window.__renderTotalsWithDiscount?.();
              return;
            }

            setErrorBorder(false);
            window.__checkoutState.discount = res.discount;
            window.__checkoutState.code = code.toUpperCase();
            if (msgEl) msgEl.textContent = `C√≥digo aplicado: ${code.toUpperCase()} (-${fmt(res.discount)})`;
            window.__renderTotalsWithDiscount?.();

            // üîí NUEVO: limpiar input y bloquear bot√≥n definitivamente en esta sesi√≥n
            codeInput.value = "";
            btn.disabled = true;
            btn.classList.remove("enabled");
            btn.dataset.locked = "1";
          };

          btn.onclick = apply;
          codeInput.onkeydown = (e)=>{ if (e.key === "Enter") { e.preventDefault(); apply(); }};
        })(mobile);
      }
    }
  };
})();
</script>



<script>
  document.addEventListener('DOMContentLoaded', () => {
    const envioRadios = document.querySelectorAll('input[name="metodo-envio"]');

    function toggleEnvioPanels() {
      document.querySelectorAll('#envio-accordion .accordion-panel').forEach(panel => {
        panel.classList.remove('open');
      });

      const selected = document.querySelector('#envio-accordion input[name="metodo-envio"]:checked');
      if (selected) {
        const panel = selected.closest('.accordion-item').querySelector('.accordion-panel');
        panel.classList.add('open');
      }
    }

    envioRadios.forEach(radio => {
      radio.addEventListener('change', toggleEnvioPanels);
    });

    toggleEnvioPanels(); // Ejecutar al cargar
  });
</script>


<script>
  function mostrarPreview(inputFile, previewId, containerId) {
    const preview = document.getElementById(previewId);
    const container = document.getElementById(containerId);
    if (inputFile.files && inputFile.files[0]) {
      const reader = new FileReader();
      reader.onload = function(e) {
        preview.src = e.target.result;
        preview.style.display = "block";
        container.style.display = "block";
      };
      reader.readAsDataURL(inputFile.files[0]);
    }
  }

  function eliminarPreview(inputId, previewId, containerId) {
    document.getElementById(inputId).value = "";
    document.getElementById(previewId).src = "";
    document.getElementById(previewId).style.display = "none";
    document.getElementById(containerId).style.display = "none";
  }

document.getElementById("ref-pago-movil").addEventListener("change", function () {
    mostrarPreview(this, "preview-pago-movil", "container-pago-movil");
  });

  document.getElementById("ref-transferencia").addEventListener("change", function () {
    mostrarPreview(this, "preview-transferencia", "container-transferencia");
  });

  document.getElementById("ref-paypal").addEventListener("change", function () {
    mostrarPreview(this, "preview-paypal", "container-paypal");
  });

  document.getElementById("ref-zelle").addEventListener("change", function () {
    mostrarPreview(this, "preview-zelle", "container-zelle");
  });
</script>

<script>
  document.getElementById('estado').addEventListener('change', () => {
    const estado = document.getElementById('estado').value;
    if (estado === 'Capital') {
      document.querySelector('input[name="metodo-envio"][value="capital"]').checked = true;
    } else {
      document.querySelector('input[name="metodo-envio"][value="resto"]').checked = true;
    }

    // Forzar reapertura de panel correcto
    const evento = new Event('change');
    document.querySelector('input[name="metodo-envio"]:checked').dispatchEvent(evento);
  });
</script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const envioRadios = document.querySelectorAll('input[name="metodo-envio"]');
    const subtotalElement = document.getElementById("subtotal-value");
    const envioCostElement = document.getElementById("envio-cost");
    const totalFinalElement = document.getElementById("total-final");

    let subtotal = 0;

// Obtener subtotal inicial desde HTML
if (subtotalElement) {
  subtotal = parseFloat(subtotalElement.textContent.replace('$', '')) || 0;
}

function actualizarTotal() {
  const envioSeleccionado = document.querySelector('input[name="metodo-envio"]:checked');
  const costoEnvio = parseFloat(envioSeleccionado.getAttribute('data-costo')) || 0;

  envioCostElement.textContent = `$${costoEnvio.toFixed(2)}`;
  totalFinalElement.textContent = `$${(subtotal + costoEnvio).toFixed(2)}`;

  // ‚¨áÔ∏è Forzar que el total respete el descuento aplicado
  window.__renderTotalsWithDiscount && window.__renderTotalsWithDiscount();
}

envioRadios.forEach(radio => {
  radio.addEventListener('change', actualizarTotal);
});

actualizarTotal(); // Ejecutar al cargar

// ‚¨áÔ∏è Tambi√©n tras el primer c√°lculo, por si ya hab√≠a cup√≥n aplicado
window.__renderTotalsWithDiscount && window.__renderTotalsWithDiscount();

  });
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const subtotalEl = document.getElementById("subtotal-value");
  const envioCostEl = document.getElementById("envio-cost");
  const totalFinalEl = document.getElementById("total-final");
  const summaryTotalEl = document.getElementById("summary-total");
  
  let subtotal = parseFloat(subtotalEl.textContent.replace("$", "")) || 0;

  function actualizarResumen() {
    const envioSeleccionado = document.querySelector('input[name="metodo-envio"]:checked');
    const costoEnvio = parseFloat(envioSeleccionado?.getAttribute("data-costo")) || 0;

    // Actualizar valores en desktop
    envioCostEl.textContent = `$${costoEnvio.toFixed(2)}`;
    totalFinalEl.textContent = `$${(subtotal + costoEnvio).toFixed(2)}`;

    // Actualizar valores en mobile summary
    const mobileSummary = document.getElementById("mobile-summary-content");
    if (mobileSummary) {
      const envioSpan = mobileSummary.querySelector("#envio-cost");
      const totalSpan = mobileSummary.querySelector("#total-final");
      if (envioSpan) envioSpan.textContent = `$${costoEnvio.toFixed(2)}`;
      if (totalSpan) totalSpan.textContent = `$${(subtotal + costoEnvio).toFixed(2)}`;
    }

    // Actualizar el resumen header m√≥vil
    summaryTotalEl.textContent = `$${(subtotal + costoEnvio).toFixed(2)}`;
  }

  // Escuchar cambios de m√©todo de env√≠o
  document.querySelectorAll('input[name="metodo-envio"]').forEach(radio => {
    radio.addEventListener("change", actualizarResumen);
  });

  // Escuchar cambio de estado
  document.getElementById("estado").addEventListener("change", () => {
    const estado = document.getElementById("estado").value;
    if (estado === "Capital") {
      document.querySelector('input[name="metodo-envio"][value="capital"]').checked = true;
    } else {
      document.querySelector('input[name="metodo-envio"][value="resto"]').checked = true;
    }
    actualizarResumen();
  });

  // Inicializar
  actualizarResumen();
});
</script>

<script>
/* ====== Billing toggle logic (FIX) ====== */
(function billingToggleInit(){
  const chk   = document.getElementById('use-shipping-as-billing');
  const panel = document.getElementById('billing-section');

  // Campos Shipping
  const S = {
    pais:       document.getElementById('pais'),
    nombre:     document.getElementById('nombre'),
    apellido:   document.getElementById('apellido'),
    direccion:  document.getElementById('direccion'),
    ciudad:     document.getElementById('ciudad'),
    municipio:  document.getElementById('municipio'),
    estado:     document.getElementById('estado'),
    postal:     document.getElementById('postal')
  };

  // Campos Billing
  const B = {
    pais:       document.getElementById('billing-pais'),
    nombre:     document.getElementById('billing-nombre'),
    apellido:   document.getElementById('billing-apellido'),
    direccion:  document.getElementById('billing-direccion'),
    ciudad:     document.getElementById('billing-ciudad'),
    municipio:  document.getElementById('billing-municipio'),
    estado:     document.getElementById('billing-estado'),
    postal:     document.getElementById('billing-postal')
  };

  function setDisabledBilling(disabled){
    Object.values(B).forEach(el => { el.disabled = disabled; });
  }

  function copyShippingToBilling(){
    // Copiamos todo 1:1
    B.pais.value      = (S.pais.value || 'Venezuela');
    B.nombre.value    = S.nombre.value;
    B.apellido.value  = S.apellido.value;
    B.direccion.value = S.direccion.value;
    B.ciudad.value    = S.ciudad.value;
    B.municipio.value = S.municipio.value;
    B.estado.value    = S.estado.value;
    B.postal.value    = S.postal.value;
  }

  function clearBilling(){
    // Dejar inputs VAC√çOS; selects en sus defaults visibles
    if (B.nombre)     B.nombre.value    = '';
    if (B.apellido)   B.apellido.value  = '';
    if (B.direccion)  B.direccion.value = '';
    if (B.ciudad)     B.ciudad.value    = '';
    if (B.municipio)  B.municipio.value = '';
    if (B.postal)     B.postal.value    = '';
    // Defaults (si tus selects no tienen opci√≥n vac√≠a)
    if (B.estado) B.estado.value = 'Capital';
    if (B.pais)   B.pais.value   = 'Venezuela';
  }

  // Mantener sincron√≠a solo cuando est√° marcado
  Object.values(S).forEach(el=>{
    el.addEventListener('input',  ()=>{ if (chk.checked){ copyShippingToBilling(); }});
    el.addEventListener('change', ()=>{ if (chk.checked){ copyShippingToBilling(); }});
  });

  // Abre/cierra panel y aplica reglas
  function refreshPanel(){
    if (chk.checked){
      // Usar env√≠o como facturaci√≥n: oculto, sincronizado y bloqueado
      copyShippingToBilling();
      setDisabledBilling(true);
      panel.classList.remove('open');
      panel.setAttribute('aria-hidden','true');
    } else {
      // Usar facturaci√≥n distinta: visible, habilitado y VAC√çO
      panel.classList.add('open');
      panel.setAttribute('aria-hidden','false');
      setDisabledBilling(false);
      clearBilling();                 // <-- clave del fix: limpiar siempre al desmarcar
    }
  }

  // Estado inicial
  refreshPanel();

  // Al cambiar el checkbox, aplicar comportamiento
  chk.addEventListener('change', refreshPanel);

  // Exponer helpers para submit
  window.__billingHelpers = {
    useShipping: () => chk.checked,
    getBilling:  () => ({
      pais:      B.pais.value || 'Venezuela',
      nombre:    B.nombre.value || '',
      apellido:  B.apellido.value || '',
      direccion: B.direccion.value || '',
      ciudad:    B.ciudad.value || '',
      municipio: B.municipio.value || '',
      estado:    B.estado.value || 'Capital',
      postal:    B.postal.value || ''
    }),
    syncNow: copyShippingToBilling
  };
})();
</script>
  

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import {getFirestore, addDoc, collection, serverTimestamp, setDoc, doc, runTransaction, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";



/* ================== Firebase ================== */
const firebaseConfig = {
  apiKey: "AIzaSyD3u2GKMSAKC_1Cd88KA-rxTOf_Jnt3fuM",
  authDomain: "sucesso-74f7c.firebaseapp.com",
  projectId: "sucesso-74f7c",
  storageBucket: "sucesso-74f7c.appspot.com",
  messagingSenderId: "878844661636",
  appId: "1:878844661636:web:6382f86f18201aecfdd7d1"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let currentUser = null;
onAuthStateChanged(auth, (user) => { currentUser = user ? user : null; });

/* ============== Dominio base din√°mico ============== */
/* Usa el mismo origen real de la p√°gina (funciona con https://sucessobrand.com o https://www.sucessobrand.com) */
const BASE_ORIGIN = (typeof window !== "undefined" && window.location && window.location.origin)
  ? window.location.origin
  : "https://sucessobrand.com";

/* ========= Helpers de URL/imagen para emails ========= */
function absolutizeUrl(url) {
  if (!url) return "";
  if (/^(https?:|data:|gs:)/i.test(url)) return url; // ya absoluta o data (no la usaremos en email)
  const raw = url.startsWith("/") ? `${BASE_ORIGIN}${url}` : `${BASE_ORIGIN}/${url}`;
  try {
    const u = new URL(raw);
    u.pathname = u.pathname
      .split("/")
      .map(seg => seg ? encodeURIComponent(decodeURIComponent(seg)) : seg)
      .join("/");
    return u.toString();
  } catch {
    return raw.replace(/ /g, "%20");
  }
}

/* Devuelve la mejor URL de imagen p√∫blica posible para EMAILS */
function pickImageFromProduct(p) {
  if (!p) return "";

  // 1) Claves m√°s comunes en tu flujo y variantes posibles
  const candidates = [
    p.image, p.imagen, p.imagen_frontal, p.thumbnail, p.imageUrl, p.img, p.foto, p.photo, p.cover,
    // estructuras anidadas t√≠picas
    p.images?.front, p.images?.main, p.images?.[0], p.gallery?.[0], p.pictures?.[0],
    // por si viene en variantes
    p.variantImage, p.selectedImage
  ].filter(Boolean);

  // 2) Si no viene nada, intenta deducir por slug/t√≠tulo en carpeta IMAGES (no rompe si no existe)
  if (!candidates.length) {
    const name = p.name || p.nombre || "";
    const slug = (p.slug || (name && name.toLowerCase().trim()
      .replace(/\s+/g, "-").replace(/[^a-z0-9\-]/g, ""))) || "placeholder";
    candidates.push(`IMAGES/${slug}.png`, `IMAGES/${slug}.jpg`, `images/${slug}.png`, `images/${slug}.jpg`);
  }

  // 3) Normaliza y toma la primera que sea v√°lida para clientes de correo
  for (const c of candidates) {
    if (!c) continue;

    // Evitar esquemas que los clientes bloquean
    if (/^(blob:|data:)/i.test(String(c))) continue;

    // Mantener URLs p√∫blicas de Firebase Storage
    if (/^https?:\/\/firebasestorage\.googleapis\.com\//i.test(String(c))) return c;

    // Para rutas locales, fuerza absoluta https
    const abs = absolutizeUrl(String(c));
    if (/^https:\/\//i.test(abs)) return abs;
  }

  // 4) Fallback seguro (favicon de tu sitio)
  return `${BASE_ORIGIN}/images/sucesso%20fav%20icon.png`;
}

function normalizeImageUrl(url) {
  // Conservada por compatibilidad con llamadas existentes
  return pickImageFromProduct({ image: url });
}

function toSlug(str) {
  return String(str || "")
    .toLowerCase()
    .trim()
    .replace(/\s+/g, "-")
    .replace(/[^a-z0-9\-]/g, "");
}

/* ============ RENDER DE ITEMS PARA EMAIL (con im√°genes OK) ============ */
function renderItemsEmailHTML(items, { currency = "USD", locale = "es-VE" } = {}) {
  const fmt = new Intl.NumberFormat(locale, { style: "currency", currency });
  const esc = (s) => String(s ?? "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  const n = (v) => Number(v || 0);

  let html = `
<table role="presentation" width="100%" cellspacing="0" cellpadding="0" style="border-collapse:collapse;">
  <tbody>
`;

  items.forEach((it) => {
    const title = it.nombre || it.title || it.name || "Producto";
    const size  = it.talla  || it.size  || "√önica";
    const qty   = n(it.cantidad ?? it.quantity ?? 1) || 1;
    const unit  = n(it.precio   ?? it.price    ?? 0);

    const slug       = it.slug || it.handle || toSlug(title);
    const productUrl = absolutizeUrl(it.productUrl || `product-page.html?slug=${encodeURIComponent(slug)}`);

    // Forzar URL absoluta https para email
    const imgUrl = pickImageFromProduct(it);

    html += `
  <tr>
    <td style="padding:0 0 16px 0;">
      <table role="presentation" width="100%" cellspacing="0" cellpadding="0" style="border-collapse:collapse;">
        <tr>
          <!-- Imagen -->
          <td style="width:96px;vertical-align:top;padding:8px 12px 8px 0;">
            <a href="${productUrl}" target="_blank" style="text-decoration:none;display:inline-block;">
              <img src="${imgUrl}" alt="${esc(title)}" width="96" height="96"
                   style="display:block;width:96px;height:96px;object-fit:contain;border:1px solid #eee;background:#f8f8f8;">
            </a>
          </td>

          <!-- Texto -->
          <td style="vertical-align:top;padding:8px 0;">
            <a href="${productUrl}" target="_blank" style="text-decoration:none;color:#111;">
              <p style="margin:0 0 6px 0;font-weight:600;line-height:1.35;">${esc(title)}</p>
            </a>
            <p style="margin:0 0 6px 0;color:#666;">TALLA: ${esc(size)}</p>
            <p style="margin:0 0 6px 0;color:#111;">${fmt.format(unit)}</p>
            <p style="margin:0;color:#111;">QTY - ${esc(qty)}</p>
          </td>
        </tr>
      </table>
      <hr style="border:none;border-top:1px solid #e6e6e6;margin:12px 0 0 0;">
    </td>
  </tr>
`;
  });

  html += `
  </tbody>
</table>
`;
  return html;
}

// === Generador de n√∫mero de pedido de 6 d√≠gitos aleatorios (con intento de unicidad) ===
async function generateSixDigitOrderNumber(db) {
  const pick = () => String(Math.floor(100000 + Math.random() * 900000)); // 100000‚Äì999999

  // Intentamos hasta 8 veces evitar colisi√≥n de ID en la colecci√≥n "compras"
  for (let i = 0; i < 8; i++) {
    const candidate = pick();
    try {
      const ref = doc(db, "compras", candidate);
      const snap = await getDoc(ref);
      if (!snap.exists()) return candidate;  // libre, √∫salo
    } catch (e) {
      // Si por reglas no podemos leer, devolvemos el candidato y manejamos colisi√≥n en el set/add
      return candidate;
    }
  }
  // Como fallback final, devolvemos uno cualquiera
  return pick();
}




/* ================================================ */

document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById("checkout-form");

  // Abrir/cerrar paneles de m√©todos de pago
  const metodoPagoRadios = document.querySelectorAll('input[name="metodo-pago"]');
  function togglePagoPanels() {
    document.querySelectorAll('.accordion .accordion-panel').forEach(p => p.classList.remove('open'));
    const selected = document.querySelector('input[name="metodo-pago"]:checked');
    if (selected) selected.closest('.accordion-item').querySelector('.accordion-panel').classList.add('open');
  }
  metodoPagoRadios.forEach(r => r.addEventListener('change', togglePagoPanels));
  togglePagoPanels();

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    // Validaciones m√≠nimas de requeridos
    let valid = true;
    form.querySelectorAll("[required]").forEach(el => {
      if (!el.value.trim()) { el.reportValidity(); valid = false; }
    });
    if (!valid) return;

    // Comprobantes seg√∫n m√©todo
    const metodoPago = document.querySelector('input[name="metodo-pago"]:checked')?.value;
    const need = (id) => document.getElementById(id).files.length;
    if (metodoPago === "pago-movil"    && !need("ref-pago-movil"))    return alert("Debes subir el comprobante de Pago M√≥vil.");
    if (metodoPago === "transferencia" && !need("ref-transferencia")) return alert("Debes subir el comprobante de Transferencia.");
    if (metodoPago === "paypal"        && !need("ref-paypal"))        return alert("Debes subir el comprobante de PayPal.");
    if (metodoPago === "zelle"         && !need("ref-zelle"))         return alert("Debes subir el comprobante de Zelle.");

    // Carrito y sesi√≥n
    const carrito = JSON.parse(localStorage.getItem("carrito")) || [];
    if (!carrito.length) return alert("Tu carrito est√° vac√≠o.");
    const user = auth.currentUser;
    if (!user) { alert("Debes iniciar sesi√≥n para confirmar tu compra."); window.location.href = "login.html"; return; }

    // Totales
    const envio       = document.querySelector('input[name="metodo-envio"]:checked');
    const envioCosto  = parseFloat(envio?.getAttribute("data-costo")) || 0;
    const descuento   = (window.__checkoutState?.discount || 0);
    const cupon       = (window.__checkoutState?.code || null);

    const toNum = (v) => (typeof v === "number" ? v : parseFloat(String(v ?? 0).replace(/[^0-9.-]+/g,"")) || 0);
    const toInt = (v) => (typeof v === "number" ? v : parseInt(v ?? 1, 10) || 1);

    const subtotal = carrito.reduce((acc, p) => acc + toNum(p.price ?? p.precio) * toInt(p.quantity ?? p.cantidad), 0);
    const total    = Math.max(0, subtotal - descuento) + envioCosto;

    // SHIPPING y BILLING
    const shipping = {
      pais:       document.getElementById("pais").value || "Venezuela",
      nombre:     document.getElementById("nombre").value,
      apellido:   document.getElementById("apellido").value,
      direccion:  document.getElementById("direccion").value,
      ciudad:     document.getElementById("ciudad").value,
      municipio:  document.getElementById("municipio").value,
      estado:     document.getElementById("estado").value,
      postal:     document.getElementById("postal").value
    };

    const useShipAsBill = (window.__billingHelpers?.useShipping?.() === true);
    const billing = useShipAsBill
      ? { ...shipping }
      : (window.__billingHelpers?.getBilling?.() || { ...shipping });

    // Documento V/E + n√∫mero (ya validado en otros scripts)
    const docPrefix = (document.getElementById("doc-prefix").value || "V").toUpperCase();
    const docNumber = (document.getElementById("documento-number").value || "").trim();
    const docFull   = `${docPrefix}-${docNumber}`;

    // Normalizar items para guardar y para email (imagen absoluta + URL producto)
    const normalizados = carrito.map(p => {
      const nombre = p.name || p.nombre || "Producto";
      const slug   = p.slug || p.handle || (nombre ? nombre.toLowerCase().trim().replace(/\s+/g,"-").replace(/[^a-z0-9\-]/g,"") : "");
      const productUrl = p.productUrl || (slug ? `${BASE_ORIGIN}/product-page.html?slug=${encodeURIComponent(slug)}` : `${BASE_ORIGIN}/`);

      // **AQU√ç** garantizamos imagen v√°lida para EMAIL
      const image  = pickImageFromProduct(p);

      return {
        nombre,
        cantidad: toInt(p.quantity ?? p.cantidad),
        precio:   toNum(p.price ?? p.precio), // unitario
        talla:    p.size || p.talla || "√önica",
        color:    p.color || p.colorName || "",
        slug,
        productUrl,
        image
      };
    });

    const datosCompra = {
      uid: user.uid,
      email:    document.getElementById("email").value,
      telefono: document.getElementById("phone").value,
      documento: docFull,

      // SHIPPING
      nombre:    shipping.nombre,
      apellido:  shipping.apellido,
      direccion: shipping.direccion,
      ciudad:    shipping.ciudad,
      municipio: shipping.municipio,
      estado:    shipping.estado,
      postal:    shipping.postal,
      pais:      shipping.pais,

      // BILLING
      billing_nombre:    billing.nombre,
      billing_apellido:  billing.apellido,
      billing_direccion: billing.direccion,
      billing_ciudad:    billing.ciudad,
      billing_municipio: billing.municipio,
      billing_estado:    billing.estado,
      billing_postal:    billing.postal,
      billing_pais:      billing.pais,

      metodo_envio: envio?.value || "N/A",
      metodo_pago:  metodoPago || "N/A",
      items: normalizados,
      subtotal,
      envio: envioCosto,
      descuento,
      codigo_descuento: cupon,
      total,
      fecha: serverTimestamp()
    };

    // UI bloquear submit
    const submitBtn = document.querySelector('#checkout-form button[type="submit"]');
    if (submitBtn) { submitBtn.disabled = true; submitBtn.textContent = 'Procesando...'; }

    // Helper env√≠o EmailJS silencioso
    async function safeSend(service, template, vars, label) {
      try {
        if (!window.emailjs) throw new Error("EmailJS no cargado");
        await emailjs.send(service, template, vars);
        return true;
      } catch (e) {
        console.error(`Fallo env√≠o ${label}:`, e);
        return false;
      }
    }
    const toMoney = (n) => Number(n || 0).toFixed(2);

    try {
// 1) Generar n√∫mero de pedido de 6 d√≠gitos
const orderNumber = await generateSixDigitOrderNumber(db);

// Usaremos preferentemente el ID del doc = orderNumber para que sea f√°cil de encontrar.
// Si las reglas no permiten setDoc con ID arbitrario, caemos a addDoc (ID interno distinto).
let orderId = orderNumber;
try {
  await setDoc(doc(db, "compras", orderNumber), { ...datosCompra, orderNumber }, { merge: false });
} catch (e) {
  console.warn("Fallo setDoc(compras, orderNumber). Uso addDoc fallback:", e);
  const ref = await addDoc(collection(db, "compras"), { ...datosCompra, orderNumber });
  orderId = ref.id; // ID interno (no visible al cliente)
}

// Guarda el n√∫mero para mostrarlo en thank-you (si esa p√°gina lo lee de localStorage)
try { localStorage.setItem("last_order_number", orderNumber); } catch(e) {}




      // 2) Construir items_html ‚Äúbonito‚Äù para email (con im√°genes absolutas y codificadas)
      const items_html = renderItemsEmailHTML(datosCompra.items, { currency: "USD", locale: "es-VE" });
      const nowStr = new Date().toLocaleString();

      // 3) Emails
      await safeSend(
        "service_8yvqy7r",
        "template_id2awis",  // ADMIN
        {
          to_email: datosCompra.email,
          email:    datosCompra.email,
          customer_name:       `${datosCompra.nombre} ${datosCompra.apellido}`.trim(),
          customer_first_name: datosCompra.nombre,
          phone:               datosCompra.telefono,

          order_id: orderNumber,
          order_date: nowStr,
          fecha: nowStr,

          subtotal:  toMoney(datosCompra.subtotal),
          shipping:  toMoney(datosCompra.envio),
          envio:     toMoney(datosCompra.envio),
          tax:       "0.00",
          discount:  toMoney(datosCompra.descuento),
          descuento: toMoney(datosCompra.descuento),
          total:     toMoney(datosCompra.total),

          payment_method: (datosCompra.metodo_pago || 'N/A').toUpperCase(),
          metodo_pago:    (datosCompra.metodo_pago || 'N/A').toUpperCase(),
          metodo_envio:   (datosCompra.metodo_envio || 'N/A').toUpperCase(),

          shipping_name:     `${datosCompra.nombre} ${datosCompra.apellido}`.trim(),
          shipping_address1: datosCompra.direccion,
          shipping_address2: '',
          shipping_city:     datosCompra.ciudad,
          shipping_state:    datosCompra.estado,
          shipping_postal:   datosCompra.postal,
          shipping_country:  datosCompra.pais,

          billing_name:     `${datosCompra.billing_nombre} ${datosCompra.billing_apellido}`.trim(),
          billing_address1: datosCompra.billing_direccion,
          billing_address2: '',
          billing_city:     datosCompra.billing_ciudad,
          billing_state:    datosCompra.billing_estado,
          billing_postal:   datosCompra.billing_postal,
          billing_country:  datosCompra.billing_pais,

          order_status_url: `${BASE_ORIGIN}/mi-pedido`,
          faq_url:          `${BASE_ORIGIN}/faq`,
          terms_url:        `${BASE_ORIGIN}/terminos`,
          site_url:         `${BASE_ORIGIN}/`,
          support_email:    "help.sucsso@gmail.com",

          items_html
        },
        "ADMIN"
      );

      await safeSend(
        "service_8yvqy7r",
        "template_y1gnb4l",  // CLIENTE
        {
          to_email: datosCompra.email,
          email:    datosCompra.email,
          customer_name:       `${datosCompra.nombre} ${datosCompra.apellido}`.trim(),
          customer_first_name: datosCompra.nombre,
          phone:               datosCompra.telefono,

          order_id: orderNumber,
          order_date: nowStr,
          fecha: nowStr,

          subtotal:  toMoney(datosCompra.subtotal),
          shipping:  toMoney(datosCompra.envio),
          envio:     toMoney(datosCompra.envio),
          tax:       "0.00",
          discount:  toMoney(datosCompra.descuento),
          descuento: toMoney(datosCompra.descuento),
          total:     toMoney(datosCompra.total),

          payment_method: (datosCompra.metodo_pago || 'N/A').toUpperCase(),
          metodo_pago:    (datosCompra.metodo_pago || 'N/A').toUpperCase(),
          metodo_envio:   (datosCompra.metodo_envio || 'N/A').toUpperCase(),

          shipping_name:     `${datosCompra.nombre} ${datosCompra.apellido}`.trim(),
          shipping_address1: datosCompra.direccion,
          shipping_address2: '',
          shipping_city:     datosCompra.ciudad,
          shipping_state:    datosCompra.estado,
          shipping_postal:   datosCompra.postal,
          shipping_country:  datosCompra.pais,

          billing_name:     `${datosCompra.billing_nombre} ${datosCompra.billing_apellido}`.trim(),
          billing_address1: datosCompra.billing_direccion,
          billing_address2: '',
          billing_city:     datosCompra.billing_ciudad,
          billing_state:    datosCompra.billing_estado,
          billing_postal:   datosCompra.billing_postal,
          billing_country:  datosCompra.billing_pais,

          order_status_url: `${BASE_ORIGIN}/mi-pedido`,
          faq_url:          `${BASE_ORIGIN}/faq`,
          terms_url:        `${BASE_ORIGIN}/terminos`,
          site_url:         `${BASE_ORIGIN}/`,
          support_email:    "help.sucsso@gmail.com",

          items_html
        },
        "CLIENTE"
      );

      // 4) Limpiar carrito y redirigir
      try { localStorage.removeItem("carrito"); } catch(e){}
      window.location.href = "thank-you.html";
      setTimeout(() => {
        if (!/thank-you\.html/i.test(window.location.href)) {
          window.location.assign("thank-you.html");
        }
      }, 800);

    } catch (err) {
      console.error("Error registrando compra:", err);
      alert("Hubo un error al registrar tu compra. Intenta nuevamente.");
      const submitBtn = document.querySelector('#checkout-form button[type="submit"]');
      if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'Confirmar Compra'; }
    }
  });
});
</script>






<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script>
  // Inicializa EmailJS apenas el DOM est√° listo (no esperar onload)
  document.addEventListener('DOMContentLoaded', function () {
    try {
      if (window.emailjs && !emailjs.__inited) {
        emailjs.init("ZBp0ewAzqXPihpO94"); // tu PUBLIC KEY
        emailjs.__inited = true;
      }
    } catch(e) {
      console.error("No se pudo inicializar EmailJS:", e);
    }
  });
</script>


<script>
function toggleMobileSummary() {
  const content = document.getElementById("mobile-summary-content");
  const toggleIcon = document.getElementById("summary-toggle");

  if (content.classList.contains("open")) {
    content.classList.remove("open");
    toggleIcon.textContent = "+";
  } else {
    content.classList.add("open");
    toggleIcon.textContent = "‚àí";
  }
}

document.addEventListener("DOMContentLoaded", () => {
  // Copiar el contenido de la summary-section al resumen m√≥vil
  const summaryHTML = document.querySelector(".summary-section").innerHTML;
  document.getElementById("mobile-summary-content").innerHTML = summaryHTML;
// Re-vincular listeners del cup√≥n en el contenedor m√≥vil
window.__rebindDiscountBox && window.__rebindDiscountBox();


  // Actualizar el total
  const total = document.getElementById("total-final").textContent;
  document.getElementById("summary-total").textContent = total;
});
</script>

  
</body>
</html>
